\documentclass[12pt]{article}
\usepackage{graphicx}
\usepackage{float}
\usepackage{subcaption}
\usepackage{hyperref}
\usepackage{mathtools}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage[authoryear]{natbib}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{bigints}
\usepackage{array}
\usepackage{geometry}
%\usepackage{breqn}

\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}

\setlength{\parskip}{\baselineskip}
\setlength{\parindent}{0pt}

\newcommand{\e}[1]{{\mathbb E}\left[ #1 \right]}
\newcommand{\var}[1]{{\mathbb V \textnormal{ar}}\left[ #1 \right]}
%\newcommand{\det}[1]{{ | #1 |}
\newcommand{\gb}[1]{{\color{blue}{(#1)}}}
\newcommand{\plr}[1]{{\it\color{RedViolet}{(#1)}}}
\newcommand{\gc}[1]{{\it\color{ForestGreen}{(#1)}}}
\DeclareMathOperator*{\V}{Var}

\geometry{a4paper}

\title{Inference of Continuous and Discrete Population Structure Through Space and Time}
\date{\vspace{-5ex}}
\author{Gideon S. Bradburd$^{1,a}$, Peter L. Ralph$^{2,b}$, Graham M. Coop$^{1,c}$}

\begin{document}

\maketitle

\textsuperscript{1}Center for Population Biology, Department of Evolution and Ecology, University of California, Davis, CA 95616

\textsuperscript{2}Department of Molecular and Computational Biology, University of Southern California, Los Angeles, CA 90089

\textsuperscript{a}gbradburd@ucdavis.edu; 
\textsuperscript{b}pralph@usc.edu;
\textsuperscript{c}gmcoop@ucdavis.edu\\\\\

\newpage

\section{Data}
At each variable, bi-allelic locus, we have picked an allele to count in each sample, and we also know the number of chromosomes genotyped in each sample.  We can then define the sample allele frequency at locus $\ell$ in sample $n$ as 
\begin{equation}
\hat{F}_{\ell,n} = \frac{C_{\ell,n}}{S_{\ell,n}}
\label{sample_freqs}
\end{equation}

Our inference framework proceeds by modeling the covariance in allele frequencies 
as a Wishart-distributed random variable, 
but the sample allele frequencies are not multivariate normally distributed.
so we standardize the allele frequencies.
The standardization we use proceeds as follows:
\begin{align}
&\bar{F}_{\ell} = \frac{1}{N}\sum\limits_NF_{\ell,n} \\ \notag
&\bar{F}^{*}_{\ell} = \frac{1}{N+1}\left( 0.5 + \sum\limits_N	F_{\ell,n} \right)   \\ \notag
&X_{\ell,n} = \frac{\hat{F}_{\ell,n} - \bar{F}_{\ell}}{\sqrt{\bar{F}^{*}_{\ell} (1-\bar{F}^{*}_{\ell})}}
\label{sample_freqs}
\end{align}

We then can define the covariance of the standardized allele frequencies 
across all $L$ variable, and we model that covariance.

\begin{equation}
\widehat{\Omega} = \frac{1}{L} X^TX
\label{sample_std_cov}
\end{equation}


\section{Model}
We define a parametric covariance, $\Omega$, which will serve as 
the mean of the Wishart distribution from which we are treating 
the sample covariance of the standardized sample allele frequencies 
as a draw.  This parametric covariance is a function both discrete population 
structure (i.e., samples can draw ancestry from one or more discrete clusters) 
as well as a continuous decay of covariance with distance within each cluster 
(i.e., a pair of samples drawing all of their ancestry from a single cluster are expected 
to have lower covariance with each other the farther apart they occur).

We begin by defining the spatial covariance function in the $k^{\text{th}}$ cluster, $F^{(k)}$, 
as a function of the geographic distance $D_{i,j}$ between a pair of samples, $i$ and $j$:
\begin{equation}
F^{(k)}_{i,j} = \alpha^{(k)}_0 \times \text{exp} \left(-\left( \alpha^{(k)}_D * D_{i,j}	\right)^{\alpha^{(k)}_2}	\right) + \mu^{(k)}
\label{spatial_cov}
\end{equation}

We can then define the admixed covariance function between the same pair of samples, 
which incorporates both the discrete, between-cluster structure, as well as the continuous 
differentiation within each cluster.
\begin{equation}
\Omega_{i,j} = \sum\limits_K \left(	w^{(k)}_iw^{(k)}_j F^{(k)}_{i,j} \right) + 
	\delta_{i=j} \left[
		\left(1-\sum\limits_K \left(	w^{(k)}_iw^{(k)}_j F^{(k)}_{i,i}\right)\right) \times 
		\left( \eta_i + \frac{1}{S_i} \right)
			\right]
\label{ad_cov_spMultiK}
\end{equation}

There are 4 models in this conceptual framework (3 others in addition to the one listed above:
\begin{enumerate}
\item spatial model with multiple clusters
	\begin{equation}
	\Omega_{i,j} = \sum\limits_K \left(	w^{(k)}_iw^{(k)}_j F^{(k)}_{i,j} \right) + 
		\delta_{i=j} \left[
			\left(1-\sum\limits_K \left(	w^{(k)}_iw^{(k)}_j F^{(k)}_{i,i}\right)\right) \times 
			\left( \eta_i + \frac{1}{S_i} \right)
				\right] \notag
	\end{equation}
\item nonspatial model with multiple clusters
	\begin{equation}
	\Omega_{i,j} = \sum\limits_K \left(	w^{(k)}_iw^{(k)}_j \mu^{(k)} \right) + 
		\delta_{i=j} \left[
			\left(1-\sum\limits_K \left(	w^{(k)}_iw^{(k)}_j \mu^{(k)}\right)\right) \times 
			\left( \eta_i + \frac{1}{S_i} \right)
				\right] \notag
	\end{equation}
\item spatial model with a single cluster
	\begin{equation}
	\Omega_{i,j} = F_{i,j}  + 
		\delta_{i=j} \left[
			\left(1-F_{i,i}\right) \times 
			\left( \eta_i + \frac{1}{S_i} \right)
				\right] \notag
	\end{equation}
\item nonspatial model with a single cluster
	\begin{equation}
	\Omega_{i,j} = \mu + 
		\delta_{i=j} \left[
			\left(1-\mu \right) \times 
			\left( \eta_i + \frac{1}{S_i} \right)
				\right] \notag
	\end{equation}
\end{enumerate}

\section{Likelihood}
The sample covariance of the standardized allele frequencies has rank $N-1$, 
so we compute the likelihood of an ($N-1$)-dimensional projection of the data.
Following SpaceMix, we create a mean-centering matrix $T$, where 
\begin{equation}
T = \delta_{i,j} - \frac{1}{N}
\label{mc_matrix}
\end{equation}
and we choose a projection matrix $\Psi$ by dropping the last column 
of the orthogonal matrix in the QR decomposition of $T$.

We then calculate the likelihood of the data as
\begin{equation}
P(\widehat{\Omega} \; | \; \Omega) = \mathcal{W}(L\Psi^T \Omega \Psi \; , \; L)
\label{likelihood}
\end{equation} 

\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Model}
Ok so we have $N$ individuals sampled throughout time and space, 
and, for each individual, we have the genotype at each of $L$ loci.
We are interested in modeling both continuous patterns of population differentiation 
(isolation across space and over time), as well as discrete population structure.
In space, discrete structure might be due to a barrier to dispersal, 
or to a recent expansion event that has brought relatively differentiated groups into geographic contact.
In time, discrete structure might correspond to population replacement, 
or the sudden influx of gene flow from somewhere not nearby.

To model these dual patterns of structure (continuous in time and space, as well as discrete), 
we say that there are $K$ populations in space-time.  
Within each population (which are roughly analogous to the clusters in STRUCTURE),
covariance decays continuously with spatial and temporal distance. 
The spatiotemporal covariance between individuals $i$ and $k$ takes the following form in population $k$:
\begin{equation}
\label{eq:pop_cov}
F^{(k)}_{i,j} = \alpha^{(k)}_0 \text{exp} \left(	  \left( \frac{D_{i,j}}{\alpha^{(k)}_D} + \frac{\tau_{i,j}}{\alpha^{(k)}_{\tau}} \right) ^{\alpha^{(k)}_2} \right)
\end{equation}

\gb{Peter, this form of covariance is a placeholder.  
I've been looking into different forms from Gneiting 2002, 
but would love some feedback on considerations 
when choosing which properties of which Matern functions are desirable}.

Individuals are then admixed between those populations, 
choosing membership $w^{(k)}$ in population $k$, 
where $w^{(k)}$ is the probability that a sampled allele came from population $k$.

We model the covariance in allele frequencies, $\Omega$, across loci between individuals $i$ and $j$
as a sum of their spatiotemporal covariances within each cluster, weighted by their
membership proportions in each cluster.

\begin{equation}
\label{eq:total_cov}
\Omega_{i,j} = \sum\limits_K \left(w_i^{(k)}w_j^{(k)} \left( F^{(k)}_{i,j} + \mu^{(k)} \right)\right) + \gamma + \delta_{i=j} \eta_i
\end{equation}

Here, $\mu^{(k)}$ is the population-level effect of sharing some deviation away from an ancestral allele frequency, 
$\gamma$ is the global effect of sharing an ancestral allele frequency, $\delta$ is an indicator variable that takes the value 1 when index $i$ is equal to index $j$, and $\eta$ is the sample-specific nugget on the diagonal of the covariance matrix.
\newpage
\gb{Graham, I have two questions for you:
\begin{itemize}
\item First, do you remember the conversation we had in your office about short-term and 
long-term tweaks to spatialStructure's current model?  I remember that we discussed two 
short-term tweaks: (1) one that involved incorporating a sample size effect onto the diagonal of the 
covariance matrix, and (2) \textbf{something else}.  To my shame, I can neither remember what the other 
thing was nor (since I moved out of the office) can I find the notes that I took on it.  So, question 1 is: 
do you remember what the other thing was?
\item Question 2 has to do with the sample size effect.  I've been playing around with it a little bit and 
hitting a conceptual wall.  Here are my thoughts:
From the binomial, the variance of $f$ is $\frac{f(1-f)}{N}$, where $N$ is the sample size.  So, if the 
allele frequencies across all loci in a sample were identical, their variance would be just given by 
$\frac{f(1-f)}{N}$.

Now, if we allow $f$ to vary across loci, and if we say that $f_{i}$ denotes the vector 
of allele frequencies in sample $i$ across all $L$ loci, then I think, when we had talked 
about it, that we arrived at the following:

\begin{equation}
Var(f_{i}) =  Var(\epsilon) + \frac{1}{L}\sum\limits_{L}\left(f_{\ell}(1-f_{\ell})/N_{i}\right)
\end{equation}
where $\epsilon_{\ell}$ gives the ancestral allele frequency at locus $\ell$, 
and $Var(\epsilon)$ is hopefully captured by our $\gamma$ parameter. 
This equation appears to hold true in tests, both from simulated 
and empirical datasets.

So, the question is, how do we incorporate information about sample sizes 
into the model?  Considerations are: 
\begin{itemize}
\item We don't want the sample size effect 
to be greater than the actual variance in any sample, 
as the model will not be able fit the data with any parameter 
(nuggets are all positive).  Also note that we're adding 
($+ \gamma + \sum\limits_{K}w^{(k)}_i\mu^{(k)} + \eta_{i}$),
so really that presents the hard limit we don't want to be greater than 
$Var(f_{i})$
\item We may want to accommodate different sample sizes 
across loci, as those could be highly variable.  Although, maybe that's 
just too unwieldy.
\end{itemize}
Options seem to be:
\begin{itemize}
\item We make the prior of the nugget centered around $1/N$.  The upside 
here is that the model retains the flexibility to have a diagonal element on the 
parametric covariance matrix that's equal to (or, at least, not necessarily greater 
than) the true sample variance.  The downside is that maybe we don't want it to have 
that flexibility.  This option would look like:
\begin{equation}
\Omega_{i,j} = \gamma + 
			\e{\bar{f}(1-\bar{f})} 
			\left( 
			\sum\limits_{K}
				\left(w^{(k)}_{i}w^{(k)}_{j}\left( F^{(k)}_{i,j} + 
				\mu^{(k)} \right)\right) + 
			\delta_{i=j} \left(\eta_i(\frac{1}{N_{i}})\right)
			\right) 
\end{equation}
\item We just add a hard $1/N$ to the diagonal element.
This option would look like:
\begin{equation}
\Omega_{i,j} = \gamma + 
			\e{\bar{f}(1-\bar{f})}
			\left( 
			\sum\limits_{K}
				\left(w^{(k)}_{i}w^{(k)}_{j}\left( F^{(k)}_{i,j} + 
				\mu^{(k)} \right)\right) + 
			\delta_{i=j} \left(\eta_i + \frac{1}{N_{i}}\right)
			\right)
\end{equation}
\end{itemize}
\end{itemize}
Do you have any thoughts or opinions about these options?  
And also, am I missing something here?  I don't think the 
$\e{\bar{f}(1-\bar{f})}$ should be square-rooted, but maybe I'm wrong?
}
\newpage
\subsection*{shared mean business}

Our thoughts proceed as follows:\\
say $f_i$ is the allele frequency at a given locus in population $i$,\\
and $\epsilon$ is the ancestral frequency at that locus,\\
and $X_i$ is the deviation in population $i$ from $\epsilon$ at that locus (i.e., $\epsilon + X_i = f_i$):\\
\begin{align}
\text{Cov}(f_i,f_j) =& \e{f_if_j} - \e{f_i}\e{f_j}	\notag\\
			=& \e{( X_i + \epsilon) ( X_j +
                         		 \epsilon)} - \e{  X_i+ \epsilon}\e{ X_j+ \epsilon} \notag\\
			=& \e{( X_i  X_j +  X_i\epsilon +  X_j\epsilon + \epsilon^2)} -(\e{ X_i}+ \e{\epsilon})(\e{ X_j}+ \e{\epsilon}) \notag\\
			=& \e{( X_i  X_j +  X_i\epsilon +  X_j\epsilon + \epsilon^2)} -
				(\e{ X_i}\e{ X_j}+ \e{\epsilon}\e{ X_i}+ \e{\epsilon}\e{ X_j} + \e{\epsilon}^2) \notag\\
			=& \e{X_i  X_j} - \e{ X_i}\e{ X_j} \\ \notag 
			     &+ \e{X_i\epsilon} - \e{\epsilon}\e{ X_i} \\ \notag 
			     &+\e{X_j\epsilon} - \e{\epsilon}\e{ X_j} \\ \notag 
			     &+\e{\epsilon^2} - \e{\epsilon}^2  \notag\\
			&= \text{Cov}({ X_i,X_j})  + \text{Cov}(X_i,\epsilon) + 
				\text{Cov}(X_j,\epsilon) + \var{\epsilon} \notag\\
			&= \text{Cov}({ X_i,X_j}) + \var{\epsilon}
\end{align}
\\

So in Eqn. \eqref{eq:total_cov}, the $\delta$ term is describing this $\var{\epsilon}$.
If this math works, then it also means that we don't have to mean-center the loci;
we can just model covariance in sample frequencies, 
and add a single parameter to describe the increased covariance between samples across loci 
due to the ancestral mean they share at each locus.

\newpage
\section*{Binomial variance and ancestral allele frequencies}
\begin{align}
\epsilon &\sim \text{Beta}(\alpha=\beta)\\\notag
\text{Var}(X) &= \e{X^2} - \e{X}^2\\\notag
\e{X^2} &= \text{Var}(X) + \e{X}^2\\\notag
\e{(\epsilon)*(1-\epsilon)} &= \e{\epsilon - \epsilon^2}\\\notag
&= \e{\epsilon} - \e{\epsilon^2}\\\notag
&= 0.5 -  (\text{Var}(\epsilon) + \e{\epsilon}^2)\\\notag
&= 0.5 -  (\text{Var}(\epsilon) + 0.25)\\\notag
&= 0.25 -  \text{Var}(\epsilon)\\\notag
\end{align}


\newpage


\section{WAIC}
\begin{align}
WAIC =& -2 \widehat{elpd_{waic}}\\
\widehat{elpd_{waic}} =& \widehat{lpd} - \hat{p}_{waic}\\
\widehat{lpd} =& \sum\limits_N log\left(\frac{1}{S}\sum\limits_S p(y_i | \theta^s)	\right)\\
\hat{p}_{waic} =& \sum\limits_N Var_S\left( log \left( p(y_i | \theta^s) \right)	\right)\\
WAIC =& -2 \left( \sum\limits_N \left[ log\left(\frac{1}{S}\sum\limits_S p(y_i | \theta^s)	\right) \right]-
	\sum\limits_N \left[ Var_S\left( log \left( p(y_i | \theta^s) \right)	\right) \right]	\right)
\end{align}


And now, plugging in our likelihood function,

\begin{align}
p(y_i | \theta^s) =& \frac{|X|^{\frac{n-p-1}{2}}e^{\frac{-tr(V_S^{-1}X)}{2}}}
					{2^\frac{np}{2}|V_S|^{\frac{n}{2}}\Gamma_p\left(\frac{n}{2}\right)}\\
%%%%%%%%%%%%%%%%%%
WAIC =& -2 \left( \sum\limits_N \left[ log\left(\frac{1}{S}\sum\limits_S 
				\frac{|X|^{\frac{n-p-1}{2}}e^{\frac{-tr(V_S^{-1}X)}{2}}}
						{2^\frac{np}{2}|V_S|^{\frac{n}{2}}\Gamma_p\left(\frac{n}{2}\right)}
			\right)  \right ]\right.\\ \notag
	&\hspace{0.4in}-\left.\sum\limits_N \left[ Var_S\left(
			log \left( 
				\frac{|X|^{\frac{n-p-1}{2}}e^{\frac{-tr(V_S^{-1}X)}{2}}}
						{2^\frac{np}{2}|V_S|^{\frac{n}{2}}\Gamma_p\left(\frac{n}{2}\right)}
			 \right)	\right) \right] \right)\\
%%%%%%%%%%%%%%%%%%
WAIC =& -2 \left(  \sum\limits_N \left[ 
			log\left(	\frac{|X|^{\frac{n-p-1}{2}}}
						{S 2^\frac{np}{2} \Gamma_p\left(\frac{n}{2}\right)}
			\sum\limits_S 
				\frac{e^{\frac{-tr(V_S^{-1}X)}{2}}}
						{|V_S|^{\frac{n}{2}}}
			\right)  \right] \right.\\ \notag
	&\hspace{0.4in}-\left.\sum\limits_N \left[
		Var_S \left( 
			log \left(	|X|^{\frac{n-p-1}{2}}	\right) + 
			log \left( 	e^{\frac{-tr(V_S^{-1}X)}{2}}\right) \right.\right.\right.\\ \notag
				&\hspace{0.4in}-\left.\left.\left.
			log \left(	2^\frac{np}{2}	\right) -
			log \left(	|V_S|^{\frac{n}{2}}	\right) -
			log \left(	\Gamma_p\left(\frac{n}{2}\right)	 \right)
		\vphantom{
			log \left( 	e^{\frac{-tr(V_S^{-1}X)}{2}}\right)
		}
		\right)
		 \right]
		\vphantom{
			\sum\limits_N log\left(\frac{1}{S}\sum\limits_S 
				\frac{|X|^{\frac{n-p-1}{2}}e^{\frac{-tr(V_S^{-1}X)}{2}}}
					{2^\frac{np}{2}|V_S|^{\frac{n}{2}}\Gamma_p\left(\frac{n}{2}\right)}\right)
		}
\right) \\
%%%%%%%%%%%%%%%%%%
WAIC =& -2 \left(  \sum\limits_N \left[ 
			log\left(	\frac{|X|^{\frac{n-p-1}{2}}}
						{S 2^\frac{np}{2} \Gamma_p\left(\frac{n}{2}\right)}
			\right) +
			log\left(\sum\limits_S 
				\frac{e^{\frac{-tr(V_S^{-1}X)}{2}}}
						{|V_S|^{\frac{n}{2}}}
			\right)  \right] \right.\\ \notag
	&\hspace{0.4in}-\left.\sum\limits_N \left[
		Var_S \left( 
			log \left( 	e^{\frac{-tr(V_S^{-1}X)}{2}}\right) -
			log \left(	|V_S|^{\frac{n}{2}}	\right)
		\vphantom{
			log \left( 	e^{\frac{-tr(V_S^{-1}X)}{2}}\right)
		}
		\right)
		 \right]
		\vphantom{
			\sum\limits_N log\left(\frac{1}{S}\sum\limits_S 
				\frac{|X|^{\frac{n-p-1}{2}}e^{\frac{-tr(V_S^{-1}X)}{2}}}
					{2^\frac{np}{2}|V_S|^{\frac{n}{2}}\Gamma_p\left(\frac{n}{2}\right)}\right)
		}
\right) \\
%%%%%%%%%%%%%%%%%%
WAIC =& -2 \left( 
	N \times log\left(	\frac{|X|^{\frac{n-p-1}{2}}}
						{S 2^\frac{np}{2} \Gamma_p\left(\frac{n}{2}\right)}
			\right) + 
	\sum\limits_N \left[ 
			log\left(\sum\limits_S 
				\frac{e^{\frac{-tr(V_S^{-1}X)}{2}}}
						{|V_S|^{\frac{n}{2}}}
			\right)  \right] \right.\\ \notag
	&\hspace{0.4in}-\left.\sum\limits_N \left[
		Var_S \left( 
			log \left( 	e^{\frac{-tr(V_S^{-1}X)}{2}}\right) -
			log \left(	|V_S|^{\frac{n}{2}}	\right)
		\vphantom{
			log \left( 	e^{\frac{-tr(V_S^{-1}X)}{2}}\right)
		}
		\right)
		 \right]
		\vphantom{
			\sum\limits_N log\left(\frac{1}{S}\sum\limits_S 
				\frac{|X|^{\frac{n-p-1}{2}}e^{\frac{-tr(V_S^{-1}X)}{2}}}
					{2^\frac{np}{2}|V_S|^{\frac{n}{2}}\Gamma_p\left(\frac{n}{2}\right)}\right)
		}
\right) \\
\end{align}
\end{document}


\section*{spatialStructure + BayEnv?}

\begin{equation}
X_i \sim \text{MVN}	\left(	 \mu = \beta Y_i + \sum_K w^{(k)}_i \beta_{(k)}Y_i , \Omega = \widehat{\Omega}	\right)
\end{equation}









